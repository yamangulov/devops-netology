# Домашнее задание к занятию "Микросервисы: подходы"

Вы работаете в крупной компанию, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps специалисту необходимо выдвинуть предложение по организации инфраструктуры, для разработки и эксплуатации.


## Задача 1: Обеспечить разработку

Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- Облачная система;
- Система контроля версий Git;
- Репозиторий на каждый сервис;
- Запуск сборки по событию из системы контроля версий;
- Запуск сборки по кнопке с указанием параметров;
- Возможность привязать настройки к каждой сборке;
- Возможность создания шаблонов для различных конфигураций сборок;
- Возможность безопасного хранения секретных данных: пароли, ключи доступа;
- Несколько конфигураций для сборки из одного репозитория;
- Кастомные шаги при сборке;
- Собственные докер образы для сборки проектов;
- Возможность развернуть агентов сборки на собственных серверах;
- Возможность параллельного запуска нескольких сборок;
- Возможность параллельного запуска тестов;

Обоснуйте свой выбор.

Решение:

Ранее, в блоке "CI, мониторинг и управление конфигурациями" мы уже рассматривали эту тему более глубоко и с выполнением практических заданий. Фактически можно придти к такому выводу: описанные требования с некоторыми корректировками (есть кнопка или GUI страничка для управления данной конкретной функций или же нужно писать скрипт для ее реализации) любое из существующих на рынке свободных или проприетарных решений удовлетворяет заданным условиям. Также в ТЗ не вполне подробно задано, какие именно приложения используются и планируются к использованию внутри компании, это также существенно повлияет на наш выбор. Поэтому можно предложить несколько вариантов, с упором на наиболее релевантный:

1) в принципе, достаточно сочетать Gitlab CI/CD + любое облако (например, Yandex Cloud). Здесь можно всю инфраструктуру для выполнения стадий тестирования и развертывания выполнить в облаке полностью или частично (например, runner запускать в специальных vm, которые поднимаются в облаке из пайплайна). Недостатком может оказаться необходимость оплачивать накладные расходы на облачные ресурсы и реализация многих функций кастомными скриптами, что требует определенной квалификации DevOps в компании
2) можно сочетать Jenkins + GitLab + любое облако, в результате мы получим больше возможностей настроек через GUI для выполнения задач из ТЗ, но все же многое придется писать скриптами, кроме того, проект свободный, поддерживается сообществом и не требует оплаты, однако, поддержка все же отстает во времени, и не всегда jenkins способен собрать самые последние версии ОС для тестирования, это может вызвать затруднения
3) наконец, самый оптимальный, на мой взгляд, стек - это Teamcity + Gitlab + любое облако + Nexus. Этот вариант полностью предоставляет все возможности, описанные в пунктах ТЗ, сами серверы могут быть развернуты в облаке, в том числе по требованию с помощью подготовленных ansible playbook, графический интерфейс обеспечивает все возможности из ТЗ, сложные задачи можно решать с помощью доп. кастомизации скриптами. Существуют ограничения в бесплатной версии, которые легко преодолеть, используя регистрацию развернутых экземпляров на разные email адреса и своевременной очисткой неиспользуемых пайплайнов
В конечном итоге, моей рекомендацией будет вариант 3. Пример реализации функций, напоминающий данное ТЗ, можно посмотреть в одной из предыдущих домашних работ https://github.com/yamangulov/devops-netology/blob/main/ci/9.5/README.md


## Задача 2: Логи

Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- Сбор логов в центральное хранилище со всех хостов обслуживающих систему;
- Минимальные требования к приложениям, сбор логов из stdout;
- Гарантированная доставка логов до центрального хранилища;
- Обеспечение поиска и фильтрации по записям логов;
- Обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
- Возможность дать ссылку на сохраненный поиск по записям логов;

Обоснуйте свой выбор.

Решение:

В данном случае я буду рекомендовать уже проверенный многолетней практикой стек ELK:

1) filebeat и logstash умеют как собирать логи, так и парсить их и передавать в elasticsearch
2) elasticsearch - проверенное средство для сбора логов, полнотекстового поиска (под капотом использует lucene для этого), просмотра с фильтрацией и поиском по логам, имеет для этого как графический интерфейс, так и API, можно сохранять выполненный поиск с заданными параметрами как в виде url ссылки, так и запроса API с параметрами, так же имеет возможность кластеризации под нужды растущей нагрузки
3) общепринято добавлять к этому стеку Kibana, который предоставляет возможность построить более богатый набор удобных графических дашбордов для отображения данных из elasticsearch и графический интерфейс для поиска и фильтрации, для настроек и управления кластером elasticsearch



## Задача 3: Мониторинг

Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре.
Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:
- Сбор метрик со всех хостов, обслуживающих систему;
- Сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
- Сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
- Сбор метрик, специфичных для каждого сервиса;
- Пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
- Пользовательский интерфейс с возможность настраивать различные панели для отслеживания состояния системы;

Обоснуйте свой выбор.

Решение:

Общепринятым форматом для сбора метрик о состоянии хостов является формат Prometheus, поддержка которого предоставляется множеством фреймворков и стеков для разработки, а также доп. средствами в виде exporters, которые собирают и экспортируют метрики разного формата в формат Prometheus. Например, в приложениях Spring можно использовать настроенный Spring Actuator, выдающий нужные настроенные метрики. Для других ЯП, фреймворков и стеков также всегда найдутся аналогичные решения для сбора и экспорта как общих метрик состояния хостов и приложений, так и очень специфических, решений множество. Наконец, prometheus легко интегрируется с Graphana для передачи и отображения собранных метрик. Поэтому буду предлагать Prometheus + Graphana + exporters (при необходимости)

Примечание: в предыдущих блоках лекций упоминалось, что за рубежом очень часто используется стек TICK для аналогичных целей, поэтому не исключено, что если компания зарубежная, то я буду предлагать именно этот стек, как более знакомый команде DevOps компании-заказчика, в зависимости от квалификации их команды. Если команда более знакома со стеком ELK, также остановлюсь на нем.